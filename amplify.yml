version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Setting up Java and Android SDK"
        # Download and install OpenJDK manually
        - curl -O https://download.java.net/openjdk/jdk11/ri/openjdk-11+28_linux-x64_bin.tar.gz
        - mkdir -p $HOME/java
        - tar -xzf openjdk-11+28_linux-x64_bin.tar.gz -C $HOME/java
        - export JAVA_HOME=$HOME/java/jdk-11
        - export PATH=$JAVA_HOME/bin:$PATH
        - java -version
        # Install Android SDK
        - echo "Installing Android SDK"
        - curl -O https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        - mkdir -p $HOME/android-sdk/cmdline-tools
        - unzip commandlinetools-linux-9477386_latest.zip -d $HOME/android-sdk/cmdline-tools
        - mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        - export ANDROID_HOME=$HOME/android-sdk
        - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        - yes | sdkmanager --licenses
        - sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        # Install Flutter
        - curl -LO https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.24.0-stable.tar.xz
        - tar xf flutter_linux_3.24.0-stable.tar.xz
        - export PATH="$PATH:$(pwd)/flutter/bin"
        - flutter doctor
        - flutter pub get
    build:
      commands:
        - echo "Building Flutter APK"
        - flutter build apk --release
  artifacts:
    baseDirectory: build/app/outputs/flutter-apk
    files:
      - "*.apk"
  cache:
    paths:
      - .pub-cache/**/* # Cache Flutter dependencies
      - amplify/.cache # Cache Amplify backend build artifacts
      - $HOME/android-sdk # Cache Android SDK
