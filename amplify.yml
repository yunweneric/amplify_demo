version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Setting up Java 11 for Android SDK"
        # Install Java 11 (Amazon Corretto 11)
        - curl -sL https://adoptium.net/releases.html?variant=openjdk11 | grep -o 'https://cdn.azul.com/amazon-corretto/11/latest/amazon-corretto-11-x64-linux-jdk.tar.gz' | head -n 1 | xargs curl -O
        - mkdir -p $HOME/java
        - tar -xzf amazon-corretto-11-x64-linux-jdk.tar.gz -C $HOME/java
        - export JAVA_HOME=$HOME/java/amazon-corretto-11-x64-linux-jdk
        - export PATH=$JAVA_HOME/bin:$PATH
        - java -version
        # Install Android SDK
        - echo "Installing Android SDK"
        - curl -O https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        - mkdir -p $HOME/android-sdk/cmdline-tools
        - unzip commandlinetools-linux-9477386_latest.zip -d $HOME/android-sdk/cmdline-tools
        - mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        - export ANDROID_HOME=$HOME/android-sdk
        - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        - yes | sdkmanager --licenses
        - sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        # Install Flutter
        - curl -LO https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.24.0-stable.tar.xz
        - tar xf flutter_linux_3.24.0-stable.tar.xz
        - export PATH="$PATH:$(pwd)/flutter/bin"
        - flutter doctor
        - flutter pub get
    build:
      commands:
        - echo "Building Flutter APK"
        - flutter build apk --release
  artifacts:
    baseDirectory: build/app/outputs/flutter-apk
    files:
      - "*.apk"
  cache:
    paths:
      - .pub-cache/**/* # Cache Flutter dependencies
      - amplify/.cache # Cache Amplify backend build artifacts
      - $HOME/android-sdk # Cache Android SDK
